### 什么事V8

V8是一个由Google开发的开源JavaScript引擎，目前用在Chrome浏览器和nodejs中，其核功能是执行易于人类理解的JavaScript代码

那么V8又是怎么执行JavaScript代码的呢

其主要核心流程分为编译和执行两步，首先需要将JavaScript代码转换为低级中间代码或机器能够理解的机器代码，然后再执行转换后的代码并输出执行结果

你可以把V8看成是一个虚构出来的计算机，也称为虚拟机，虚拟机通过模拟实际计算机的各种功能来实现代码的执行，如模拟实际计算机的CPU，堆栈，寄存器，虚拟机还具有它自己的一套指令系统

所以对于JavaScript代码来说，V8就是他的整个世界，



提前准备运行时环境

- 堆空间
- 栈空间
- 全局执行上下文
- 全局作用域
- 内置的内建函数
- 宿主环境提供的扩展函数和对象
- 消息循环系统



消息循环系统包含了消息驱动器和消息队列，它如同V8的心脏，不断接收消息并决策如何处理消息

生成AST的同时生成作用域，作用域中存放相关变量



有了AST和作用域之后，接下来就是生成字节码了，字节码是介于AST和机器代码之间的中间代码，但是与特定的机器代码无关，解释器可以直接解释执行字节码或者通过编译器将其编译成二进制的机器代码再执行，





有了字节码之后，解释器就会按照顺序执行字节码，并输出结果



在解释器执行的过程还会有一个监控解释器执行状态的模块，在解释器执行字节码的过程中，如果发现了某一段代码被重复执行了多次，那么监控机器人就会将这段代码标记为热点代码

当某段代码被标记为热点代码，V8就会将这段字节码丢给优化编译器，优化编译器在后台将字节码编译为二进制代码，然后再对编译后的二进制代码执行优化操作，优化后的机器代码的执行效率会得到大幅提升



不过，和静态语言不同，JavaScript是一种非常灵活的动态语言，对象的结构和属性是可以在运行时任意修改的，而经过优化编译器优化过的代码只能针对某种固定的结构，一旦在执行过程中，对象的结构被动态修改，那么优化后的代码势必会变成无效代码，这时候优化编译器就需要执行反优化操作了，经过反优化的代码，下次执行的之后就会回退到解释器解释执行





后续操作都会间接或直接基于AST



源代码转换为中间代码 解释器执行中间代码

源代码转换为中间代码，编译器编译中间代码，执行机器码


v8引擎并没有使用单一的一种技术而是，混合采用两种技术，这种基础就称为（JIT just in time）即时编译技术

这是一种权衡策略，因为两种方法都有各自的优缺点，解释执行启动速度快，执行慢，编译执行启动慢执行快